Bootstrap:library
From: young-geng/ml/ubuntu_18.04_cuda11.5:latest

%files
    /global/scratch/users/liamtan/PegInsertion/requirements.txt /contained/setup/requirements.txt

%post -c /bin/bash
    source /contained/anaconda3/etc/profile.d/conda.sh
    export WANDB_API_KEY='fc50a5f4006fdb40484801211b81676767b2d1d8'
    
    export XLA_FLAGS=--xla_gpu_force_compilation_parallelism=1
    export XLA_PYTHON_CLIENT_PREALLOCATE=false
    export TF_FORCE_GPU_ALLOW_GROWTH=true

    conda create -n peg python=3.10

    conda activate peg

    pip install -r /contained/setup/requirements.txt

    pip install --upgrade "jax[cuda11_pip]" -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

    pip install torch
    
    chmod -R 777 /contained

%runscript
    #! /bin/bash
    export PYTHONPATH="$PYTHONPATH:$CODEPATH"
    echo $PYTHONPATH
    echo XLA_PYTHON_CLIENT_PREALLOCATE=false "$@"
    XLA_PYTHON_CLIENT_PREALLOCATE=false "$@"
